---
name: start_emulator
version: 0.0.1
author: R.I.Pienaar <rip@devco.net>
description: Starts the Emulator
run_as: choria=rip.mcollective
loglevel: info

uses:
  emulator: ">= 0.0.1"

data_stores:
  emulator:
    type: "file"
    file: "~/.choria-emulator.yaml"
    format: "yaml"

nodes:
  emulators:
    type: mcollective
    test: true
    at_least: 1
    agents:
      - emulator
    uses:
      - emulator

inputs:
  agents:
    description: "Number of agents to start"
    type: "Integer"
    data: "emulator/emulator_agents"

  collectives:
    description: "Number of collectives to join"
    type: "Integer"
    data: "emulator/emulator_collectives"

  instances:
    description: "Number of instances to start"
    type: "Integer"
    data: "emulator/emulator_instances"

  monitor:
    description: "Port to listen for monitor requests"
    type: "Integer"
    data: "emulator/emulator_monitor"

  servers:
    description: "NATS Servers to connect to"
    type: "String"
    validation: ":shellsafe"
    data: "emulator/emulator_servers"

  tls:
    description: "Enable TLS"
    type: "String"
    validation: ":boolean"
    default: "false"
    data: "emulator/emulator_tls"

hooks:
  pre_book:
    - data:
        action: "write"
        key: "emulator/emulator_agents"
        value: "{{{ inputs.agents }}}"

    - data:
        action: "write"
        key: "emulator/emulator_collectives"
        value: "{{{ inputs.collectives }}}"

    - data:
        action: "write"
        key: "emulator/emulator_instances"
        value: "{{{ inputs.instances }}}"

    - data:
        action: "write"
        key: "emulator/emulator_monitor"
        value: "{{{ inputs.monitor }}}"

    - data:
        action: "write"
        key: "emulator/emulator_servers"
        value: "{{{ inputs.servers }}}"

    - data:
        action: "write"
        key: "emulator/emulator_tls"
        value: "{{{ inputs.tls }}}"

tasks:
  - mcollective:
      description: "Start Emulator"
      nodes: "{{{ nodes.emulators }}}"
      action: "emulator.start"
      post:
        - summarize
      properties:
        agents: "{{{ inputs.agents }}}"
        collectives: "{{{ inputs.collectives }}}"
        instances: "{{{ inputs.instances }}}"
        monitor: "{{{ inputs.monitor }}}"
        servers: "{{{ inputs.servers }}}"
        tls: "{{{ inputs.tls }}}"

  - mcollective:
      description: "Emulator Status"
      nodes: "{{{ nodes.emulators }}}"
      action: "emulator.emulator_status"
      silent: true
      post:
        - summarize
