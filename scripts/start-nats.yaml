---
name: start_nats
version: 0.0.1
author: R.I.Pienaar <rip@devco.net>
description: Starts NATS on every node to create Federation Collectives
run_as: choria=rip.mcollective
loglevel: info

uses:
  emulator: ">= 0.0.1"

data_stores:
  emulator:
    type: "file"
    file: "~/.choria-emulator.yaml"
    format: "yaml"
    create: true

nodes:
  emulators:
    type: mcollective
    test: true
    at_least: 1
    agents:
      - emulator
    uses:
      - emulator

inputs:
  monitor:
    description: "Port to listen for monitor requests"
    type: "Integer"
    data: "emulator/nats_monitor"
    save: true

  port:
    description: "Port to listen for client connections"
    type: "Integer"
    data: "emulator/nats_port"
    save: true

tasks:
  - mcollective:
      description: "Start NATS"
      nodes: "{{{ nodes.emulators }}}"
      action: "emulator.start_nats"
      post:
        - summarize
      properties:
        monitor_port: "{{{ inputs.monitor }}}"
        port: "{{{ inputs.port }}}"
